name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Clean server app directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd /opt/IntoTheNight
          echo "Cleaning app directory..."
          rm -rf app/*
          mkdir -p app
          echo "App directory cleaned"
          
    - name: Upload build files
      run: |
        echo "Uploading build files..."
        # Создаем архив с билдом
        tar -czf build.tar.gz -C Build/Linux .
        
        # Копируем архив на сервер
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' scp \
          -o StrictHostKeyChecking=no \
          -P ${{ secrets.SERVER_PORT }} \
          build.tar.gz \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/IntoTheNight/app/
          
        # Очищаем локальный архив
        rm build.tar.gz
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd /opt/IntoTheNight/app
          echo "Extracting build files..."
          tar -xzf build.tar.gz
          rm build.tar.gz
          echo "Files in app directory:"
          ls -la
          echo "Setting executable permissions..."
          chmod +x *.x86_64 2>/dev/null || true
          chmod +x *.sh 2>/dev/null || true
          
          cd ..
          echo "Restarting containers..."
          docker-compose down
          docker-compose build --no-cache unity-app
          docker-compose up -d
          echo "Deployment completed!"